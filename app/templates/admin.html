<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>
    <link href="{{ static.styles }}" rel="stylesheet">
    <script src="{{ static.vue }}"></script>
    <script src="{{ static.axios }}"></script>
</head>

<body id="top">
<!-- Navigation-->
<nav class="navbar navbar-expand-lg navbar-light fixed-top shadow-sm" id="mainNav">
    <div class="container px-5">
        <img src="{{ url_for('static', path='/icons/logo.png') }}" style="max-width: 70px; max-height:70px;">
        <a class="navbar-brand fw-bold" href="#">Launch DIDComm server components</a>
        <button aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"
                data-bs-target="#navbarResponsive" data-bs-toggle="collapse" type="button">
            Menu
            <i class="bi-list"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ms-auto me-4 my-3 my-lg-0">
                <li class="nav-item"><a class="nav-link me-lg-3" href="{{features}}" target="_blank">Features</a></li>
                <li class="nav-item"><a class="nav-link me-lg-3" href="{{download}}" target="_blank">Download</a></li>
                {% if current_user %}
                    <li class="nav-item"><a class="nav-link me-lg-3" href="{{ base_url }}/logout">Logout [{{ current_user.username }}]</a></li>
                {% endif %}
            </ul>
            <!--
            <button class="btn btn-primary rounded-pill px-3 mb-2 mb-lg-0" data-bs-target="#feedbackModal"
                    data-bs-toggle="modal">
                        <span class="d-flex align-items-center">
                            <i class="bi-chat-text-fill me-2"></i>
                            <span class="small">Send Feedback</span>
                        </span>
            </button>
            -->
        </div>
    </div>
</nav>
<!-- Mashead header-->
<header class="masthead" id="app">
    <div class="container px-5">
        <div class="row gx-5 align-items-center">
            <div class="col-lg-6">
                <!-- Register form-->
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <!--
                           Login form
                        -->
                        <div v-if="current_step == 0" class="card">
                            <div class="card-header">Login</div>
                            <div class="card-body">
                                {% include "forms/login.html" %}
                            </div>
                        </div>
                        <!--
                           Form for creation admin account (if not exists)
                        -->
                        <div v-if="current_step == 1" class="card">
                            <div class="card-header">Step-1: Create Admin account</div>
                            <div class="card-body">
                                {% include "forms/create_user.html" %}
                            </div>
                        </div>
                        <!--
                           Form to configure webroot and LetsEncrypt
                        -->
                        <div v-if="current_step == 2" class="card">
                            <div class="card-header">Step-2: Configure webroot URL</div>
                            <div class="card-body">
                                {% include "forms/webroot.html" %}
                            </div>
                        </div>
                        <!--
                           Form to configure SSL & ACME
                        -->
                        <div v-if="current_step == 3" class="card">
                            <div class="card-header">Step-3: Configure SSL</div>
                            <div class="card-body">
                                {% include "forms/ssl.html" %}
                            </div>
                        </div>
                        <!--
                           Form to configure Firebase secrets
                        -->
                        <div v-if="current_step == 4" class="card">
                            <div class="card-header">Step-4: Configure Firebase secrets</div>
                            <div class="card-body">
                                {% include "forms/firebase.html" %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6" v-if="current_step == 4">
                <div v-if="!events_stream_is_active" class="masthead-device-mockup">
                    <img src="/static/firebase.png" style="max-width: 700px;">
                </div>
            </div>
            <div class="col-lg-6" v-if="current_step != 4">
                <textarea id="log" v-if="events_stream_is_active" style="min-width: 500px;min-height: 400px;background-color: black; color: green;">
                    [[ log ]]
                </textarea>
                <button
                        v-if="events_stream_is_active"
                        @click.prevent="events_stream_is_active = false; log = '';"
                        type="button"
                        class="btn btn-close btn-lg btn-block"
                        style="float: right;"
                >
                </button>
                <!-- Masthead device mockup feature-->

                <div v-if="!events_stream_is_active" class="masthead-device-mockup">
                    <img src="/static/icons/lunch.gif" style="max-width: 500px;">
                </div>

            </div>
        </div>
    </div>
</header>
<!-- Quote/testimonial aside-->
<aside class="text-center bg-gradient-primary-to-secondary">
    <div class="container px-5">
        <div class="row gx-5 justify-content-center">
            <div class="col-xl-8">
                <div class="h2 fs-1 text-white mb-4">"An intuitive solution to DIDComm Messaging,
                    wrapped up in a single app!"
                </div>
            </div>
        </div>
    </div>
</aside>
<!-- Footer-->
<footer class="bg-black text-center py-5">
    <div class="container px-5">
        <div class="text-white-50 small">
            <a href="{{github}}" target="_blank">GitHub</a>
            <span class="mx-1">&middot;</span>
            <a href="{{issues}}" target="_blank">Issues</a>
            <span class="mx-1">&middot;</span>
            <a href="{{spec}}" target="_blank">Spec</a>
        </div>
    </div>
</footer>

<!-- VueJS  -->
<script>
    app = new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            current_step: {{ current_step }},
            events_stream: '{{ events_stream }}',
            events_stream_is_active: false,
            log: '',
            form_login: {
                username: '',
                password: '',
                error: ''
            },
            form_create_user: {
                username: 'admin',
                password1: '',
                password2: '',
                error: ''
            },
            form_webroot: {
                url: '{{ settings.webroot }}',
                env_url: '{{ env.webroot }}',
                full_base_url: '{{ settings.full_base_url }}',
                ping: 'starting',
                error: ''
            },
            form_ssl: {
                option: '{{ settings.ssl_option }}',
                cert_file: '{{ env.cert_file }}',
                cert_key_file: '{{ env.cert_key_file }}',
                error: '',
                acme_dir: '{{ env.acme_dir }}',
                acme_email: '{{ settings.acme_email }}',
                acme_share_email: {{ settings.acme_email_share }},
                loading: false
            },
            form_firebase: {
                api_key: "{{ settings.firebase_api_key }}",
                sender_id: "{{ settings.firebase_sender_id }}",
                error: ""
            }
        },
        methods: {
            login: function(){
                let url = '{{ base_url }}' + '/login';
                let self = this;
                axios.post(
                    url, this.form_login
                ).then(function (response) {
                    self.form_login.error = null;
                    console.log('======== SUCCESS ========')
                    console.log(response);
                    location.reload();
                }).catch(function (error) {
                    let detail = error.data.detail
                    self.form_login.error = detail;
                    console.log('======== ERROR ========')
                    console.log(error.data);
                });
            },
            create_user: function(){
                let url = '{{ base_url }}' + '/create_user';
                let self = this;
                axios.post(
                    url, this.form_create_user
                ).then(function (response) {
                    self.form_create_user.error = null;
                    console.log('======== SUCCESS ========')
                    console.log(response);
                    location.reload();
                }).catch(function (error) {
                    let detail = error.data.detail
                    self.form_create_user.error = detail;
                    console.log('======== ERROR ========')
                    console.log(error.data);
                });
            },
            set_webroot: function(){
                let url = '{{ base_url }}' + '/set_webroot';
                let self = this;
                axios.post(
                    url, {value: self.form_webroot.url}
                ).then(function (response) {
                    self.form_webroot.error = null;
                    console.log('======== SUCCESS ========')
                    console.log(response);
                    self.current_step += 1;
                }).catch(function (error) {
                    let detail = error.data.detail
                    self.form_webroot.error = detail;
                    console.log('======== ERROR ========')
                    console.log(error.data);
                });
            },
            set_ssl_option: function(){
                let url = '{{ base_url }}' + '/set_ssl_option';
                let self = this;
                self.form_ssl.loading = true;
                axios.post(
                    url, {
                        value: self.form_ssl.option,
                        email: self.form_ssl.acme_email,
                        share_email: self.form_ssl.acme_share_email,
                        stream: self.events_stream
                    }
                ).then(function (response) {
                    self.form_ssl.loading = false;
                    self.form_webroot.error = null;
                    console.log('======== SUCCESS ========')
                    console.log(response);
                    self.current_step += 1;
                }).catch(function (error) {
                    self.form_ssl.loading = false;
                    let detail = error.data.detail
                    self.form_ssl.error = detail;
                    console.log('======== ERROR ========')
                    console.log(error.data);
                });
            },
            set_firebase_secret: function(){
                let url = '{{ base_url }}' + '/set_firebase_secret';
                let self = this;
                axios.post(
                    url, {
                        api_key: self.form_firebase.api_key,
                        sender_id: self.form_firebase.sender_id
                    }
                ).then(function (response) {
                    self.form_firebase.error = null;
                    console.log('======== SUCCESS ========')
                    console.log(response);
                    self.current_step += 1;
                }).catch(function (error) {
                    let detail = error.data.detail
                    self.form_firebase.error = detail;
                    console.log('======== ERROR ========')
                    console.log(error.data);
                });
            }
        },
        computed: {
            ping_status_caption: function(){
                if (this.form_webroot.ping == 'success') {
                    return 'webroot is reachable'
                }
                else if (this.form_webroot.ping == 'error') {
                    return 'webroot is unreachable'
                }
                else if (this.form_webroot.ping == 'starting'){
                    return 'checking if webroot is reachable...'
                }
                else {
                    return ''
                }
            },
            ssl_apply_enabled: function(){
                let enabled = false;
                if (this.form_ssl.option === 'manual') {
                    enabled = this.form_ssl.cert_file && this.form_ssl.cert_file;
                    if (!enabled) {
                        this.form_ssl.error = 'You should set env vars CERT_FILE and CERT_KEY_FILE to enable this option';
                    }
                }
                else if (this.form_ssl.option === 'acme') {
                    enabled = !(this.form_ssl.cert_file && this.form_ssl.cert_file) && this.form_ssl.acme_dir;
                    if (!enabled) {
                        if (!this.form_ssl.acme_dir) {
                            this.form_ssl.error = 'You should set ACME_DIR env var to enable this option';
                        }
                        else {
                            this.form_ssl.error = 'You should unset env vars CERT_FILE and CERT_KEY_FILE to enable this option';
                        }
                    }
                }
                else if (this.form_ssl.option === 'external') {
                    enabled = !(this.form_ssl.cert_file && this.form_ssl.cert_file);
                    if (!enabled) {
                        this.form_ssl.error = 'You should unset env vars CERT_FILE and CERT_KEY_FILE to enable this option';
                    }
                }
                if (enabled) {
                    this.form_ssl.error = '';
                }
                if (enabled) {
                    return true;
                }
                else {
                    return false;
                }
            }
        }
    });

    function connect() {
        let stream_socket = new WebSocket('{{events_stream_ws}}');

        stream_socket.onclose = function (event) {
            setTimeout(function() {
              connect();
            }, 1000);
        };

        stream_socket.onmessage = function (event) {
            app.$data.events_stream_is_active = true;
            let js = JSON.parse(event.data);
            app.$data.log += '\r\n' + js.msg;
            let log = document.getElementById('log');
            if (log) {
                log.scrollTop = log.scrollHeight;
            }
        };

        stream_socket.onerror = function (error) {
            console.log("WS Error " + error.message);
        };
    }

    connect();

</script>

</body>

</html>